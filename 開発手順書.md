# 飲食店営業情報管理システム 開発手順書

## 概要

本開発は、動作確認を随時行いながらステップバイステップで進める方針とします。基本フローは以下の通りです：

1. スプレッドシート用意（データ受け取り用の仮版）
2. PWA開発（簡易版→機能拡張）
3. スプレッドシートのブラッシュアップ（GAS機能追加）

## 事前準備: 開発環境セットアップ（初心者向け）

### ステップ0.1: Nodeのインストール
- [x] Node.jsをインストール
  - [Node.js公式サイト](https://nodejs.org/)にアクセス
  - 「LTS」バージョンをダウンロード
  - ダウンロードしたインストーラーを実行し、指示に従ってインストール
  - インストール完了後、コマンドプロンプトまたはPowerShellを開き`node -v`と入力して正常にバージョンが表示されることを確認

### ステップ0.2: Claspのセットアップ
- [x] Claspのインストール
  - コマンドプロンプトまたはPowerShellを開く
  - 以下のコマンドを実行してClaspをインストール：
    ```
    npm install -g @google/clasp
    ```
  - `clasp -v`と入力してインストールを確認

- [x] Googleへのログイン
  - コマンドプロンプトで以下を実行：
    ```
    clasp login
    ```
  - ブラウザが開き、Googleアカウントへのログインを求められる
  - 「許可」をクリックして認証を完了

- [x] Google Apps Script APIの有効化
  - [Google Apps Script API設定ページ](https://script.google.com/home/usersettings)にアクセス
  - 「Google Apps Script API」をONに設定

## フェーズ1: スプレッドシート準備（1日）

### ステップ1.1: 基本スプレッドシートの作成
- [x] 新規Googleスプレッドシートを作成
  - [Google Drive](https://drive.google.com/)にアクセス
  - 左上の「新規」ボタン→「Googleスプレッドシート」をクリック
  - スプレッドシートが開いたら、上部の「無題のスプレッドシート」をクリックして「HOT情報管理システム」に変更
  
- [x] シート1を「データ受信用」と命名
  - シート下部のタブ「Sheet1」を右クリック→「名前を変更」→「データ受信用」と入力

- [x] 以下のカラムを設定:
  - A1セルに「タイムスタンプ」と入力
  - B1セルに「ルート名」と入力
  - C1セルに「緯度」と入力
  - D1セルに「経度」と入力
  - E1セルに「カテゴリ」と入力
  - F1セルに「コメント」と入力
  - G1セルに「画像URL」と入力
  - H1セルに「住所」と入力
  - 1行目を選択し、「データ」→「フィルタを作成」でフィルター機能を追加
  - 1行目を選択し、「表示形式」→「太字」でヘッダーを強調表示

### ステップ1.2: Claspプロジェクトの初期設定
- [x] プロジェクトフォルダを作成
  - PCの任意の場所に「HOT情報」フォルダを作成
  - コマンドプロンプトを開き、作成したフォルダに移動

- [x] Claspプロジェクトの作成
  - スプレッドシートのURLからIDを取得（https://docs.google.com/spreadsheets/d/【ここがID】/edit）
  - コマンドプロンプトで以下を実行：
    ```
    clasp create --title "HOT情報管理システム" --type sheets --parentId "【スプレッドシートのID】"
    ```
  - プロジェクトが作成されると`.clasp.json`ファイルが生成される

- [x] 初期ファイル作成
  - エディタで「Code.js」という名前のファイルを作成し、以下のコードを貼り付け：

```javascript
function doGet(e) {
  return HtmlService.createHtmlOutput("HOT情報管理システムのAPIです");
}

function doPost(e) {
  try {
    // パラメータ取得
    const params = JSON.parse(e.postData.contents);
    
    // データシート取得
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("データ受信用");
    
    // データ追加
    sheet.appendRow([
      new Date(),
      params.route || "",
      params.latitude || "",
      params.longitude || "",
      params.category || "",
      params.comment || "",
      params.imageUrl || "",
      params.address || ""
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({
      "result": "success"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      "result": "error",
      "message": error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
```

- [x] ファイルをアップロード
  - コマンドプロンプトで以下を実行：
    ```
    clasp push
    ```
  - 「Manifest file has been updated. Do you want to push and overwrite?」と聞かれたら「y」と入力

### ステップ1.3: 画像保存用フォルダ設定
- [x] Googleドライブに「HOT情報画像」フォルダを作成
  - [Google Drive](https://drive.google.com/)を開く
  - 左上の「新規」ボタン→「フォルダ」→「HOT情報画像」と入力→「作成」をクリック
  - 作成したフォルダを開き、URLからフォルダIDを取得（https://drive.google.com/drive/folders/【ここがID】）
  - このIDをメモしておく（後でスクリプトに使用）

- [x] スクリプトにフォルダIDを追加
  - 先ほど作成したCode.jsに以下の関数を追加：

```javascript
// グローバル変数
const FOLDER_ID = "【先ほど取得したフォルダID】";

// 画像処理用関数（今後使用）
function saveImageToFolder(base64Image, fileName) {
  try {
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const blob = Utilities.newBlob(Utilities.base64Decode(base64Image), 'image/jpeg', fileName);
    const file = folder.createFile(blob);
    return file.getUrl();
  } catch (error) {
    console.error("画像保存エラー: " + error.toString());
    return null;
  }
}
```

- [x] 再度アップロード
  - `clasp push`コマンドでスクリプトをアップロード

### ステップ1.4: Webアプリとして公開
- [x] スクリプトエディタを開く
  - 次のコマンドを実行してブラウザでスクリプトエディタを開く：
    ```
    clasp open
    ```

- [x] アプリとしてデプロイ
  - スクリプトエディタの画面右上「デプロイ」→「新しいデプロイ」をクリック
  - 「種類の選択」で「ウェブアプリ」を選択
  - 説明に「HOT情報管理システムAPI v1」と入力
  - 「次のユーザーとしてアプリケーションを実行」を「自分」に設定
  - 「アクセスできるユーザー」を「全員（匿名ユーザーを含む）」に設定（誰でもアクセス可能に）
  - 「デプロイ」ボタンをクリック
  - 表示されるウェブアプリのURLをコピーして保存（PWA開発時に使用）

### ステップ1.5: 動作テスト
- [x] POSTMANなどのツールでテスト送信
  - テスト用のHTMLフォームを作成（test_form.html）
  - GETメソッドを使用してデータを送信
  - WebアプリのURLにフォームデータを送信

- [x] データがスプレッドシートに記録されることを確認
  - スプレッドシートを開き、新しい行にデータが追加されているか確認
  - タイムスタンプ、ルート名、緯度、経度、カテゴリ、コメント、画像URLが正しく表示されていることを確認

## フェーズ2: PWA開発（基本機能）（3-4日）

### ステップ2.1: プロジェクト初期化
- [ ] 開発用フォルダ作成
  - PC上に「pwa」というフォルダをClaspプロジェクトフォルダ内に作成
  - 以下のファイルを作成：
    - index.html（メインのHTMLファイル）
    - styles.css（スタイルシート）
    - app.js（JavaScriptコード）
    - manifest.json（PWAマニフェスト）
    - service-worker.js（オフライン機能用）

### ステップ2.2: 超簡易UI実装
- [ ] ルート選択画面のみの超シンプルUIを実装
- [ ] ドロップダウンでルート選択後、すぐにカメラ起動する設計
- [ ] 基本的なHTML/CSSフレームワーク導入

### ステップ2.3: カメラ機能実装
- [ ] カメラAPIを利用した写真撮影機能実装
- [ ] 撮影後のプレビュー表示
- [ ] 位置情報取得機能実装

### ステップ2.4: データ送信機能
- [ ] フォーム入力とデータ送信機能実装
- [ ] 画像のBase64エンコード処理
- [ ] スプレッドシートのWebアプリURLへのPOST処理
- [ ] エラーハンドリング（通信エラー時の再送機能）

### ステップ2.5: PWA対応
- [ ] マニフェストファイル作成
- [ ] サービスワーカー実装（キャッシュ制御）
- [ ] オフライン時のデータ保存機能

### ステップ2.6: 最初のデプロイと動作確認
- [ ] ローカルテスト実施
- [ ] 仮デプロイ（GitHub Pages等）
- [ ] 実際のスマートフォンでの動作確認
- [ ] QRコード生成と配布準備

## フェーズ3: PWA改良（3日）

### ステップ3.1: UI/UX改善
- [ ] 画面遷移アニメーション追加
- [ ] エラーメッセージの日本語化
- [ ] 大きなボタン・フォント設定（操作性向上）
- [ ] 明確な進行状況表示

### ステップ3.2: パフォーマンス最適化
- [ ] 画像圧縮処理最適化
- [ ] 通信最適化（低速回線対応）
- [ ] 処理の非同期化

### ステップ3.3: オフライン機能強化
- [ ] バックグラウンド同期機能の実装
- [ ] 接続復帰時の自動送信
- [ ] キャッシュ管理改善

### ステップ3.4: ユーザビリティテスト
- [ ] 実際の配送担当者による操作テスト
- [ ] フィードバック収集と反映
- [ ] 操作時間の計測（15秒以内の目標を確認）

## フェーズ4: スプレッドシートブラッシュアップ（4-5日）

### ステップ4.1: GAS機能拡張（Clasp使用）
- [ ] 画像処理機能の強化
  - Code.jsに画像処理関数を拡張：
  ```javascript
  function processImage(base64Image, routeName) {
    // Base64デコード処理
    // 画像保存処理
    // URL返却処理
  }
  ```
- [ ] Base64画像データの受信と保存機能追加
- [ ] 共有可能なURLの生成処理追加
- [ ] `clasp push`でスクリプトを更新

### ステップ4.2: 位置情報→住所変換機能
- [ ] Google Maps Geocoding API連携
  - [Google Cloud Platform](https://console.cloud.google.com/)で新規プロジェクト作成
  - Geocoding APIを有効化
  - APIキーを取得し、制限を設定
  - Claspプロジェクトに位置情報変換関数を追加

### ステップ4.3: データ管理シート作成
- [ ] 新しいシート「データ管理用」を作成
- [ ] 優先度、ステータス管理機能の実装
- [ ] フィルタ機能、条件付き書式の設定

### ステップ4.4: 定期処理の設定
- [ ] 古いデータの自動アーカイブ設定
  - Claspで時間駆動型トリガー関数を作成
  - `clasp push`でスクリプトを更新
  - スクリプトエディタでトリガーを設定
- [ ] 画像の定期圧縮・最適化処理
- [ ] 定期バックアップ設定

### ステップ4.5: 分析機能の実装
- [ ] 地域別・カテゴリ別の集計表示
- [ ] シンプルなダッシュボード作成
- [ ] レポート自動生成機能

## フェーズ5: 総合テストと運用準備（2日）

### ステップ5.1: 総合動作テスト
- [ ] 全フローの検証
- [ ] 異常系テスト（通信エラー、不正データ等）
- [ ] パフォーマンステスト

### ステップ5.2: マニュアル作成
- [ ] 配送担当者向け簡易マニュアル
- [ ] 営業担当者向けスプレッドシート操作マニュアル
- [ ] トラブルシューティングガイド

### ステップ5.3: 運用開始準備
- [ ] QRコード印刷・配布
- [ ] 初期説明会（使い方説明）
- [ ] フィードバック収集方法の確立

### ステップ5.4: 正式リリース
- [ ] 本番環境へのデプロイ
- [ ] 段階的な利用開始（一部ルートから開始）
- [ ] サポート体制の確立

## 想定所要期間

- フェーズ1: 1日
- フェーズ2: 3-4日
- フェーズ3: 3日
- フェーズ4: 4-5日
- フェーズ5: 2日

合計: 約2週間（13-15日）

## 注意事項

1. **各フェーズでの動作確認を重視**: 次フェーズに進む前に必ず動作確認を実施
2. **配送担当者の業務を最優先**: 操作時間の短縮を常に意識した設計を維持
3. **段階的な機能拡張**: 基本機能の安定動作確認後に追加機能を実装
4. **データ容量管理**: 初期段階から画像の自動圧縮・削除ルールを適用
5. **低スペックデバイス対応**: 古いスマートフォンでも動作するよう配慮
6. **初心者向けヘルプ**: 操作に迷った場合はこの手順書の詳細説明を参照

## 初心者向け補足情報

### Claspコマンドリファレンス
- `clasp login` - Googleアカウントにログイン
- `clasp logout` - ログアウト
- `clasp create` - 新しいプロジェクト作成
- `clasp pull` - 最新のスクリプトをダウンロード
- `clasp push` - ローカルの変更をアップロード
- `clasp open` - ブラウザでスクリプトエディタを開く

### 便利なリンク集
- [Google Apps Script公式ドキュメント](https://developers.google.com/apps-script)
- [Clasp GitHub](https://github.com/google/clasp)
- [PWA開発ガイド](https://web.dev/progressive-web-apps/)
- [Postmanダウンロード](https://www.postman.com/downloads/)
